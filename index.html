<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Viajes</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { -webkit-font-smoothing: antialiased; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const hoy = new Date().toISOString().split("T")[0];
        
        window.storage = {
            get: async (k) => { const v = localStorage.getItem(k); return v ? { key: k, value: v } : null; },
            set: async (k, v) => { localStorage.setItem(k, v); return { key: k, value: v }; },
            delete: async (k) => { localStorage.removeItem(k); return { key: k, deleted: true }; }
        };

        function App() {
          const [viajes, setViajes] = useState([]);
          const [gastos, setGastos] = useState([]);
          const [vista, setVista] = useState('agregar');
          const [viaje, setViaje] = useState({ diaCarga: hoy, origen: '', destino: '', toneladas: '', nroCartaPorte: '', tarifa: '', factura: '' });
          const [gasto, setGasto] = useState({ fecha: hoy, monto: '', descripcion: 'Combustible' });
          const [tutorial, setTutorial] = useState(false);
          const [msg, setMsg] = useState('');
          const [err, setErr] = useState({});
          const [busqueda, setBusqueda] = useState('');

          useEffect(() => { 
            (async () => {
              try {
                const v = await window.storage.get('viajes');
                if (v?.value) setViajes(JSON.parse(v.value));
                const g = await window.storage.get('gastos');
                if (g?.value) setGastos(JSON.parse(g.value));
              } catch (e) {}
              if (!localStorage.getItem('tut') && viajes.length === 0) setTutorial(true);
            })();
          }, []);

          const guardarV = async (nv) => { try { await window.storage.set('viajes', JSON.stringify(nv)); } catch (e) {} };
          const guardarG = async (ng) => { try { await window.storage.set('gastos', JSON.stringify(ng)); } catch (e) {} };
          
          const mostrarMsg = (m) => { setMsg(m); setTimeout(() => setMsg(''), 3000); };

          const addViaje = () => {
            const e = {};
            if (!viaje.diaCarga) e.diaCarga = 1;
            if (!viaje.origen) e.origen = 1;
            if (!viaje.destino) e.destino = 1;
            setErr(e);
            if (Object.keys(e).length > 0) { alert('‚ö†Ô∏è Completa los campos en rojo'); return; }
            const nv = [...viajes, { ...viaje, id: Date.now() }];
            setViajes(nv);
            guardarV(nv);
            setViaje({ diaCarga: hoy, origen: '', destino: '', toneladas: '', nroCartaPorte: '', tarifa: '', factura: '' });
            mostrarMsg('‚úì Viaje agregado');
            setErr({});
          };

          const addGasto = () => {
            const e = {};
            if (!gasto.fecha) e.fecha = 1;
            if (!gasto.monto) e.monto = 1;
            setErr(e);
            if (Object.keys(e).length > 0) { alert('‚ö†Ô∏è Completa los campos en rojo'); return; }
            const ng = [...gastos, { ...gasto, id: Date.now() }];
            setGastos(ng);
            guardarG(ng);
            setGasto({ fecha: hoy, monto: '', descripcion: 'Combustible' });
            mostrarMsg('‚úì Gasto agregado');
            setErr({});
          };

          const delViaje = (id, v) => {
            if (confirm(`¬øEliminar ${v.origen} ‚Üí ${v.destino}?`)) {
              const nv = viajes.filter(x => x.id !== id);
              setViajes(nv);
              guardarV(nv);
              mostrarMsg('‚úì Eliminado');
            }
          };

          const delGasto = (id, g) => {
            if (confirm(`¬øEliminar gasto $${g.monto}?`)) {
              const ng = gastos.filter(x => x.id !== id);
              setGastos(ng);
              guardarG(ng);
              mostrarMsg('‚úì Eliminado');
            }
          };

          const totV = viajes.reduce((a, v) => {
            const t = parseFloat(v.toneladas) || 0;
            const r = parseFloat(v.tarifa) || 0;
            const s = t * r;
            a.s += s; a.i += s * 0.21; a.t += s * 1.21;
            return a;
          }, { s: 0, i: 0, t: 0 });

          const totG = gastos.reduce((a, g) => a + (parseFloat(g.monto) || 0), 0);
          const ivaG = gastos.reduce((a, g) => a + ((parseFloat(g.monto) || 0) * 0.21), 0);
          const ivaN = totV.i - ivaG;

          const viajesFiltrados = viajes.filter(v => {
            const termino = busqueda.toLowerCase();
            return v.origen.toLowerCase().includes(termino) || 
                   v.destino.toLowerCase().includes(termino) ||
                   (v.nroCartaPorte && v.nroCartaPorte.toLowerCase().includes(termino)) ||
                   (v.factura && v.factura.toLowerCase().includes(termino)) ||
                   new Date(v.diaCarga).toLocaleDateString('es-AR').includes(termino);
          });

          return (
            <div className="min-h-screen bg-gray-50">
              {tutorial && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white p-6 max-w-md border">
                    <h2 className="text-lg font-medium mb-4">üëã Bienvenido</h2>
                    <div className="space-y-2 text-sm text-gray-600 mb-6">
                      <p><strong>Agregar Viaje:</strong> Fecha, origen y destino son obligatorios (*). Lo dem√°s es opcional.</p>
                      <p><strong>Agregar Gastos:</strong> Solo fecha y monto son obligatorios.</p>
                      <p><strong>Ver Todos:</strong> Revisa todo. El IVA se calcula autom√°ticamente.</p>
                    </div>
                    <button onClick={() => { setTutorial(false); localStorage.setItem('tut', '1'); }} 
                      className="w-full px-6 py-2 text-sm font-medium bg-gray-900 text-white hover:bg-gray-800">
                      Entendido
                    </button>
                  </div>
                </div>
              )}

              {msg && (
                <div className="fixed top-4 right-4 bg-green-50 border border-green-200 text-green-800 px-4 py-3 text-sm z-50">
                  {msg}
                </div>
              )}

              <div className="max-w-5xl mx-auto px-4 py-8">
                <div className="mb-8">
                  <div className="flex items-center justify-between mb-6">
                    <h1 className="text-2xl font-light text-gray-900">Gestor de Viajes</h1>
                    <button onClick={() => setTutorial(true)} className="text-xs text-gray-500 hover:text-gray-700">
                      ¬øC√≥mo usar?
                    </button>
                  </div>
                  
                  <div className="flex gap-1 mb-8 border-b border-gray-200">
                    {['agregar', 'gastos', 'todos'].map(v => (
                      <button key={v} onClick={() => setVista(v)} 
                        className={`px-4 py-2 text-sm font-medium ${vista === v ? 'text-gray-900 border-b-2 border-gray-900' : 'text-gray-500'}`}>
                        {v === 'agregar' ? 'Agregar Viaje' : v === 'gastos' ? 'Agregar Gastos' : 'Ver Todos'}
                      </button>
                    ))}
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div className="bg-white p-4 border">
                      <div className="text-xs text-gray-500 mb-1">Ganancia Total</div>
                      <div className="text-xl font-light text-green-600">${totV.t.toLocaleString("es-AR")}</div>
                    </div>
                    <div className="bg-white p-4 border">
                      <div className="text-xs text-gray-500 mb-1">Gastos Total</div>
                      <div className="text-xl font-light text-red-600">${totG.toLocaleString("es-AR")}</div>
                    </div>
                    <div className="bg-white p-4 border">
                      <div className="text-xs text-gray-500 mb-1">IVA a Pagar</div>
                      <div className="text-xl font-light text-orange-600">${ivaN.toLocaleString("es-AR")}</div>
                    </div>
                    <div className="bg-white p-4 border">
                      <div className="text-xs text-gray-500 mb-1">Balance Neto</div>
                      <div className={`text-xl font-light ${(totV.t - totG) >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                        ${(totV.t - totG).toLocaleString("es-AR")}
                      </div>
                    </div>
                  </div>
                </div>

                {vista === 'agregar' && (
                  <div className="bg-white border p-6 mb-6">
                    <h2 className="text-sm font-medium mb-4">Nuevo Viaje</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Fecha *</label>
                        <input type="date" value={viaje.diaCarga} onChange={e => { setViaje({...viaje, diaCarga: e.target.value}); setErr({...err, diaCarga: 0}); }}
                          className={`w-full px-3 py-2 text-sm border ${err.diaCarga ? 'border-red-500' : 'border-gray-300'} focus:outline-none focus:border-gray-900`} />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Origen *</label>
                        <input type="text" value={viaje.origen} onChange={e => { setViaje({...viaje, origen: e.target.value}); setErr({...err, origen: 0}); }}
                          className={`w-full px-3 py-2 text-sm border ${err.origen ? 'border-red-500' : 'border-gray-300'} focus:outline-none focus:border-gray-900`} placeholder="Ej: Campo Ramirez" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Destino *</label>
                        <input type="text" value={viaje.destino} onChange={e => { setViaje({...viaje, destino: e.target.value}); setErr({...err, destino: 0}); }}
                          className={`w-full px-3 py-2 text-sm border ${err.destino ? 'border-red-500' : 'border-gray-300'} focus:outline-none focus:border-gray-900`} placeholder="Ej: Rosario" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Toneladas</label>
                      <input type="number" value={viaje.toneladas} onChange={e => setViaje({...viaje, toneladas: e.target.value})} className="px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900" placeholder="Ej: 30" min="0" step="0.01" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Tarifa</label>
                      <input type="number" value={viaje.tarifa} onChange={e => setViaje({...viaje, tarifa: e.target.value})} className="px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900" placeholder="Ej: 6900" min="0" step="0.01" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Carta Porte</label>
                        <input type="text" value={viaje.nroCartaPorte} onChange={e => setViaje({...viaje, nroCartaPorte: e.target.value})} className="px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900" placeholder="Ej: E-8000" />
                      </div>
                      <div>
                      <label className="block text-xs text-gray-600 mb-1">Factura</label>
                        <input type="text" value={viaje.factura} onChange={e => setViaje({...viaje, factura: e.target.value})} className="px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900 md:col-span-3" placeholder="Ej: Borgetto" />
                        </div>
                    </div>
                    {(viaje.toneladas && viaje.tarifa) && (
                      <div className="mb-4 py-3 border-t text-xs text-gray-600">
                        Total: ${((parseFloat(viaje.toneladas) || 0) * (parseFloat(viaje.tarifa) || 0)).toLocaleString("es-AR")} ¬∑ 
                        IVA: ${(((parseFloat(viaje.toneladas) || 0) * (parseFloat(viaje.tarifa) || 0)) * 0.21).toLocaleString("es-AR")} ¬∑ 
                        Con IVA: <span className="text-green-600 font-medium">${(((parseFloat(viaje.toneladas) || 0) * (parseFloat(viaje.tarifa) || 0)) * 1.21).toLocaleString("es-AR")}</span>
                      </div>
                    )}
                    <button onClick={addViaje} className="px-6 py-2 text-sm font-medium bg-gray-900 text-white hover:bg-gray-800">Agregar Viaje</button>
                  </div>
                )}

                {vista === 'gastos' && (
                  <div className="bg-white border p-6">
                    <h2 className="text-sm font-medium mb-4">Nuevo Gasto</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Fecha *</label>
                        <input type="date" value={gasto.fecha} onChange={e => { setGasto({...gasto, fecha: e.target.value}); setErr({...err, fecha: 0}); }}
                          className={`w-full px-3 py-2 text-sm border ${err.fecha ? 'border-red-500' : 'border-gray-300'} focus:outline-none focus:border-gray-900`} />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Monto *</label>
                        <input type="number" value={gasto.monto} onChange={e => { setGasto({...gasto, monto: e.target.value}); setErr({...err, monto: 0}); }}
                          className={`w-full px-3 py-2 text-sm border ${err.monto ? 'border-red-500' : 'border-gray-300'} focus:outline-none focus:border-gray-900`} placeholder="Ej: 15000" min="0" step="0.01" />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">Categor√≠a</label>
                        <select value={gasto.descripcion} onChange={e => setGasto({...gasto, descripcion: e.target.value})} 
                          className="w-full px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900">
                          <option value="Combustible">Combustible</option>
                          <option value="Mantenimiento">Mantenimiento</option>
                          <option value="Otro">Otro</option>
                        </select>
                      </div>
                    </div>
                    {gasto.monto && (
                      <div className="mb-4 py-3 border-t text-xs text-gray-600">
                        Gasto: <span className="text-red-600 font-medium">${(parseFloat(gasto.monto) || 0).toLocaleString("es-AR")}</span> ¬∑ 
                        IVA Cr√©dito: <span className="text-green-600 font-medium">${((parseFloat(gasto.monto) || 0) * 0.21).toLocaleString("es-AR")}</span>
                        <div className="mt-1 text-gray-500">üí° El IVA de gastos se resta del IVA a pagar</div>
                      </div>
                    )}
                    <button onClick={addGasto} className="px-6 py-2 text-sm font-medium bg-gray-900 text-white hover:bg-gray-800">Agregar Gasto</button>
                  </div>
                )}

                {vista === 'todos' && (
                  <div className="space-y-6">
                    <div className="bg-white border p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-sm font-medium">Mis Viajes</h2>
                        <span className="text-xs text-gray-500">{viajesFiltrados.length} {viajesFiltrados.length === 1 ? 'viaje' : 'viajes'}</span>
                      </div>
                      
                      {viajes.length > 0 && (
                        <div className="mb-4">
                          <input 
                            type="text" 
                            value={busqueda} 
                            onChange={e => setBusqueda(e.target.value)}
                            placeholder="Buscar por origen, destino, carta porte, factura o fecha..."
                            className="w-full px-3 py-2 text-sm border border-gray-300 focus:outline-none focus:border-gray-900"
                          />
                        </div>
                      )}
                      
                      {viajes.length === 0 ? (
                        <div className="text-center py-12">
                          <div className="text-gray-400 mb-2">üì¶</div>
                          <div className="text-sm text-gray-500 mb-2">No hay viajes a√∫n</div>
                          <button onClick={() => setVista('agregar')} className="text-sm text-gray-700 hover:text-gray-900 underline">Agregar primer viaje</button>
                        </div>
                      ) : viajesFiltrados.length === 0 ? (
                        <div className="text-center py-12">
                          <div className="text-gray-400 mb-2">üîç</div>
                          <div className="text-sm text-gray-500 mb-2">No se encontraron viajes</div>
                          <button onClick={() => setBusqueda('')} className="text-sm text-gray-700 hover:text-gray-900 underline">Limpiar b√∫squeda</button>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          {viajesFiltrados.sort((a, b) => new Date(b.diaCarga) - new Date(a.diaCarga)).map(v => (
                            <div key={v.id} className="flex items-center gap-4 py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                              <div className="flex-1 min-w-0">
                                <div className="text-sm font-medium text-gray-900 truncate">{v.origen} ‚Üí {v.destino}</div>
                                <div className="text-xs text-gray-500">{new Date(v.diaCarga).toLocaleDateString('es-AR')}{v.toneladas && ` ¬∑ ${v.toneladas}t`}{v.tarifa && ` ¬∑ $${v.tarifa}/t`}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-sm font-medium text-green-600">${((parseFloat(v.toneladas) || 0) * (parseFloat(v.tarifa) || 0)).toLocaleString("es-AR")}</div>
                                <div className="text-xs text-gray-500">{v.factura || v.nroCartaPorte || '‚Äî'}</div>
                              </div>
                              <button onClick={() => delViaje(v.id, v)} className="text-gray-400 hover:text-red-600 text-xs ml-2 px-2">‚úï</button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    <div className="bg-white border p-6">
                      <div className="flex justify-between mb-4">
                        <h2 className="text-sm font-medium">Mis Gastos</h2>
                        <span className="text-xs text-gray-500">{gastos.length} {gastos.length === 1 ? 'gasto' : 'gastos'}</span>
                      </div>
                      {gastos.length === 0 ? (
                        <div className="text-center py-12">
                          <div className="text-gray-400 mb-2">üí∞</div>
                          <div className="text-sm text-gray-500 mb-2">No hay gastos a√∫n</div>
                          <button onClick={() => setVista('gastos')} className="text-sm text-gray-700 hover:text-gray-900 underline">Agregar primer gasto</button>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          {gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).map(g => (
                            <div key={g.id} className="flex items-center gap-4 py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                              <div className="flex-1 min-w-0">
                                <div className="text-sm font-medium text-gray-900 truncate">{g.descripcion || 'Sin descripci√≥n'}</div>
                                <div className="text-xs text-gray-500">{new Date(g.fecha).toLocaleDateString('es-AR')}</div>
                              </div>
                              <div className="text-right">
                                <div className="text-sm font-medium text-red-600">${parseFloat(g.monto).toLocaleString("es-AR")}</div>
                                <div className="text-xs text-gray-500">IVA: ${(parseFloat(g.monto) * 0.21).toLocaleString("es-AR")}</div>
                              </div>
                              <button onClick={() => delGasto(g.id, g)} className="text-gray-400 hover:text-red-600 text-xs ml-2 px-2">‚úï</button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
